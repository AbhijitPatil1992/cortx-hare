#!/usr/bin/env bash
set -eu -o pipefail

#
# Health check for the Mero confd service.
#

CONFD_STATE=$(consul kv get processes/0x7200000000000001:0x1 | jq '.state' -r)
if [[ $CONFD_STATE = 'M0_CONF_HA_PROCESS_STARTED' ]]; then
    rm -f /tmp/confd  # cleanup after the bootstrap stage
    exit 0
fi

if [[ -f /tmp/confd ]]; then
    exit 0  # confd is still starting
fi

exit 2
