#!/usr/bin/env bash
set -eu -o pipefail

# Helper script to bootstrap the cluster.

SRC_DIR="$(dirname $(readlink -f $0))"
M0_SRC_DIR=${M0_SRC_DIR:-${SRC_DIR%/*}/mero}
prog=$(basename $0)

usage() {
    echo "$prog: <cluster-description.yaml>"
    exit 1
}

(( $# != 1 )) && usage

cluster_descr=$1

cfgen_out=/tmp
cd $SRC_DIR
cfgen/cfgen -D cfgen/dhall/ -o $cfgen_out < $cluster_descr

sudo mkdir -p /etc/mero
dhall text < $cfgen_out/confd.dhall |
    $M0_SRC_DIR/utils/m0confgen > $cfgen_out/confd.xc

get_server_nodes() {
    jq -r '.servers[] | "\(.hostname) \(.ipaddr)"' $cfgen_out/consul-agents.json
}

get_client_nodes() {
    jq -r '.clients[] | "\(.hostname) \(.ipaddr)"' $cfgen_out/consul-agents.json
}

# Get my IP address (the one that the other agents will join to).
read _ join_ip <<< $(get_server_nodes | grep -w $HOSTNAME)

[[ $join_ip ]] || {
    echo 'Bootstrap should be run from the server node only.'
    exit 1
}

$SRC_DIR/update-consul-env server $join_ip '' # join_ip is our bind_ip
sudo systemctl start consul-agent

# Give Consul some time for its internal bootstrap and leader
# election. (Until then the KV Store won't be accessible.)
sleep 3

jq '[.[] | {key, value: (.value | @base64)}]' < /tmp/consul-kv.json |
    consul kv import -

#Â Our agent is ready, start all the reset server agents.
get_server_nodes | grep -vw $HOSTNAME || true | while read node bind_ip; do
    ssh $node "$SRC_DIR/update-consul-env server $bind_ip $join_ip &&
                   sudo systemctl start consul-agent"
done

# Start client agents.
get_client_nodes | while read node bind_ip; do
    ssh $node "$SRC_DIR/update-consul-env client $bind_ip $join_ip &&
                   sudo systemctl start consul-agent"
done

# Start Mero.
$SRC_DIR/bootstrap-node &

get_server_nodes | grep -vw $HOSTNAME || true | while read node _; do
    scp $cfgen_out/confd.xc $node:/tmp/
    ssh $node $SRC_DIR/bootstrap-node &
done

# Give some time for confd processes to start up.
sleep 5

get_client_nodes | while read node _; do
    ssh $node $SRC_DIR/bootstrap-node &
done
