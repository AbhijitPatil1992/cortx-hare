#!/usr/bin/env bash
set -eu -o pipefail
# set -x
export PS4='+ [${FUNCNAME[0]:+${FUNCNAME[0]}:}${LINENO}] '

# Helper script to bootstrap the cluster.

SRC_DIR="$(dirname $(readlink -f $0))"
M0_SRC_DIR=${M0_SRC_DIR:-${SRC_DIR%/*}/mero}
prog=${0##*/}

usage() {
    >&2 echo "$prog: <cluster-description.yaml>"
    exit 1
}

(( $# == 1 )) || usage

cluster_descr=$1

echo -n 'Generating cluster configuration... '
cfgen_out=/tmp
cd $SRC_DIR
cfgen/cfgen -D cfgen/dhall/ -o $cfgen_out < $cluster_descr

sudo mkdir -p /etc/mero
dhall text < $cfgen_out/confd.dhall |
    $M0_SRC_DIR/utils/m0confgen > $cfgen_out/confd.xc

get_server_nodes() {
    jq -r '.servers[] | "\(.hostname) \(.ipaddr)"' $cfgen_out/consul-agents.json
}

get_client_nodes() {
    jq -r '.clients[] | "\(.hostname) \(.ipaddr)"' $cfgen_out/consul-agents.json
}

# Get my IP address (the one that the other agents will join to).
read _ join_ip <<< $(get_server_nodes | grep -w $HOSTNAME)

[[ $join_ip ]] || {
    echo 'Bootstrap should be run from the server node only' >&2
    exit 1
}
echo 'Ok.'

echo -n 'Starting our Consul server agent... '
# $join_ip is our bind_ip address
$SRC_DIR/update-consul-env --mode server --bind $join_ip \
                           --extra-options '-ui -bootstrap-expect 1'
sudo systemctl start consul-agent

# Give Consul some time for its internal bootstrap and leader
# election. (Until then the KV Store won't be accessible.)
sleep 3
echo 'Ok.'

echo -n 'Importing configuration into the KV Store... '
jq '[.[] | {key, value: (.value | @base64)}]' < /tmp/consul-kv.json |
    consul kv import - > /dev/null
echo 'Ok.'

echo -n 'Waiting for the RC Leader to be elected...'
count=1
while ! pgrep -af 'consul.*watch.*prefix eq' > /dev/null; do
    if (( $count > 5 )); then
        consul kv put leader elect > /dev/null
        count=1
    fi
    sleep 1
    echo -n '.'
    ((count++))
done
echo ' Ok.'

echo -n 'Starting all the rest Consul server agents... '
while read node bind_ip; do
    ssh $node "$SRC_DIR/update-consul-env --mode server --bind $bind_ip \
                                          --join $join_ip &&
               sudo systemctl start consul-agent"
done < <(get_server_nodes | grep -vw $HOSTNAME || true)
echo 'Ok.'

echo -n 'Starting Consul client agents... '
while read node bind_ip; do
    ssh $node "$SRC_DIR/update-consul-env --mode client --bind $bind_ip \
                                          --join $join_ip &&
                   sudo systemctl start consul-agent"
done < <(get_client_nodes)
echo 'Ok.'

# Start Mero in two phases: 1st confd-s, then ios-es.
echo -n 'Starting Mero (phase1)... '
$SRC_DIR/bootstrap-node phase1 &
pids=($!)

while read node _; do
    scp $cfgen_out/confd.xc $node:/tmp/
    ssh $node $SRC_DIR/bootstrap-node phase1 &
    pids+=($!)
done < <(get_server_nodes | grep -vw $HOSTNAME || true)

# Check the status explicitly from each node.
for pid in ${pids[@]}; do
    wait $pid
done
echo 'Ok.'

# Now the 2nd phase (ios-es).
echo -n 'Starting Mero (phase2)... '
$SRC_DIR/bootstrap-node phase2 &
pids=($!)

while read node _; do
    ssh $node $SRC_DIR/bootstrap-node phase2 &
    pids+=($!)
done < <(get_server_nodes | grep -vw $HOSTNAME || true)

while read node _; do
    ssh $node $SRC_DIR/bootstrap-node phase2 &
    pids+=($!)
done < <(get_client_nodes)

# Check the status explicitly from each node.
for pid in ${pids[@]}; do
    wait $pid
done
echo 'Ok.'
